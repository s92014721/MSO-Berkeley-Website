/*!CK:1722379047!*//*1450249885,*/

if (self.CavalryLogger) { CavalryLogger.start_js(["eJV0h"]); }

__d('MercuryThreadlistContainer.react',['Bootloader','immutable','MercuryAPIArgsSource','MercuryConfig','MercuryFilters','MercuryThreadlistConstants','MessagingTag','P2PJewelBannerContainer.react','React','SubscriptionsHandler'],function a(b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q){'use strict';if(c.__markCompiled)c.__markCompiled();var r=p.PropTypes,s='search',t=p.createClass({displayName:'MercuryThreadlistContainer',propTypes:{ChildClass:r.func.isRequired,folder:r.string.isRequired,showCount:r.bool,showPresence:r.bool,source:r.string,threadCount:r.number,viewer:r.string.isRequired},getDefaultProps:function(){return {source:j.JEWEL};},getInitialState:function(){return {isLoading:true,isSearching:false,unreadMessageRequestThreads:[],threads:i.Map()};},componentDidMount:function(){h.loadModules(["MercuryOrderedThreadlist","MercuryThreadInformer","MercuryThreads"],(function(u,v,w){this._threadlist=u.getForFBID(this.props.viewer);this._threads=w.getForFBID(this.props.viewer);this._informer=v.getForFBID(this.props.viewer);this._subscriptions=new q();this._subscriptions.addSubscriptions(this._informer.subscribe('threadlist-updated',(function(x,y){this._updateThreads(this.props.folder,this.props.filter);}).bind(this)));this._handleFolderChange(this.props.folder,this.props.filter);}).bind(this));},componentWillReceiveProps:function(u){if(u.folder!==this.props.folder||u.filter!==this.props.filter)this._handleFolderChange(u.folder,u.filter);},componentWillUnmount:function(){this._cancelThreadsCallback();this._cancelThreadlistCallback();this._subscriptions&&this._subscriptions.release();},render:function(){var u=this.props,v=u.ChildClass,w=u.folder,x=u.filter,y=babelHelpers.objectWithoutProperties(u,['ChildClass','folder','filter']),z=this.state.isSearching?this.state.threads.get(s)||[]:this.state.threads.get(w)||[];return (p.createElement(v,babelHelpers._extends({},y,{folder:w,isLoaded:!!this._threadlist&&this._threadlist.hasLoadedThreadlist(w,x),isLoading:this.state.isLoading,isSearching:this.state.isSearching,newMessageRequestThreads:this.state.unreadMessageRequestThreads,onLoadMoreRequest:this._loadMoreThreads,onQuery:this._handleQuery,onSearchResults:this._handleSearchResults,p2pJewelBannerContainer:this._renderP2PJewelBannerContainer(),threads:z})));},_renderP2PJewelBannerContainer:function(){return (p.createElement(o,null));},_handleFolderChange:function(u,v){if(u===n.INBOX)this._loadMessageRequestThreads();if(!this._hasInitialThreads(u,v)){this._loadThreads(u,v,this.props.threadCount||m.JEWEL_THREAD_COUNT+3);}else if(this.state.isLoading){this.setState({isLoading:false},(function(){this._updateThreads(u,v);}).bind(this));}else this._updateThreads(u,v);},_loadMessageRequestThreads:function(){if(!k.CoreGraphEnabled)return;this._threadlist.getFilteredThreadlist(m.RECENT_THREAD_OFFSET,m.MAX_UNREAD_COUNT,n.PENDING,l.UNREAD,this._updateUnreadMessageRequestThreads,true,this.props.source);},_loadMoreThreads:function(){if(!this.state.isSearching&&!this.state.isLoading&&!this._threadlist.hasLoadedThreadlist(this.props.folder,this.props.filter))this._loadThreads(this.props.folder,this.props.filter,this._getThreadCount(this.props.folder)+m.JEWEL_MORE_COUNT+1);},_loadThreads:function(u,v,w){if(!this._threadlist)return;this._cancelThreadlistCallback();this.setState({isLoading:true},(function(){var x=this._threadlist.getFilteredThreadlist(m.RECENT_THREAD_OFFSET,w,u,v||l.ALL,(function(y){return this.setState({isLoading:false});}).bind(this),true,this.props.source);this._threadlistSub={subscriberID:x,folder:u,filter:v};}).bind(this));},_updateThreads:function(u,v,w){if(!this._threadlist||!this._threads)return;this._cancelThreadsCallback();var x=w||this._threadlist.getAvailableThreadlistNow(u,v);this._threadsSub=this._threads.getMultiThreadMeta(x,(function(y){this.setState({threads:this.state.threads.set(u,x.map(function(z){return y[z];}))});}).bind(this));},_updateUnreadMessageRequestThreads:function(){if(!this._threadlist||!this._threads)return;var u=this._threadlist.getAvailableThreadlistNow(n.PENDING,l.UNREAD);this._threads.getMultiThreadMeta(u,(function(v){this.setState({unreadMessageRequestThreads:u.map(function(w){return v[w];})});}).bind(this));},_hasInitialThreads:function(u,v){return !!(this._threadlist&&(this._threadlist.getThreadCount(u,v)>=m.JEWEL_THREAD_COUNT+3||this._threadlist.hasLoadedThreadlist(u,v)));},_getThreadCount:function(u){var v=this.state.threads.get(u);return v?v.length:0;},_cancelThreadsCallback:function(){this._threads&&this._threadsSub&&this._threads.unsubscribe(this._threadsSub);},_cancelThreadlistCallback:function(){this._threadlist&&this._threadlistSub&&this._threadlist.unsubscribe(this._threadlistSub.subscriberID,this._threadlistSub.folder,this._threadlistSub.filter);},_handleSearchResults:function(u,v){this.setState({isLoading:v,searchThreads:[]},(function(){return this._updateThreads(s,l.ALL,u);}).bind(this));},_handleQuery:function(u){this.setState({isSearching:!!u});}});f.exports=t;},null);